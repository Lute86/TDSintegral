doctype html
html(lang="es")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Dashboard | Clickwave
    link(href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap", rel="stylesheet")
    link(rel="stylesheet", href="/css/dashboard.css")
    link(rel="stylesheet", href="/css/modals.css")
  body.dashboard-layout
    header.header
      .header-left
        h1.logo Clickwave
      .header-center
        input#globalSearch(type="text", placeholder="Buscar proyectos, tareas o empleados...")
      .header-right
        span.user-name= user ? user.nombre : 'Empleado'
        a(href="/auth/logout").logout-btn Cerrar sesi√≥n

    main.main-content
      h2 Mi Dashboard

      .dashboard-grid
        //- PROYECTOS
        .dash-card#projectsCard
          .dash-card-header
            h3 Proyectos
            if user && user.rol === 'administrador'
              a.btn-view-all(href="#", onclick="openProjectModal(); return false;") ‚ûï Nuevo
          .dash-card-body
            ul.project-list
              if proyectos && proyectos.length > 0
                each proyecto in proyectos
                  li.project-item
                    .left
                      strong.project-name= proyecto.nombre
                      if proyecto.metricas && proyecto.metricas.horasCotizadas
                        small.project-hours üíº #{proyecto.metricas.horasCotizadas} horas cotizadas
                    .right
                      span.item-status(class=proyecto.estado)= proyecto.estado
                      if user && user.rol === 'administrador'
                        a.btn-edit(href="/project/edit/" + proyecto._id) ‚úèÔ∏è
                        form(action="/project/" + proyecto._id + "?_method=DELETE", method="POST", style="display:inline")
                          button.btn-delete(type="submit", onclick="return confirm('¬øEliminar proyecto?')") üóëÔ∏è
              else
                li.text-muted No hay proyectos asignados.

        //- TAREAS
        .dash-card#tasksCard
          .dash-card-header
            h3 Tareas del Proyecto
            if user && user.rol === 'administrador'
              a.btn-view-all(href="#", onclick="openTaskModal(); return false;") ‚ûï Nueva
          .dash-card-body
            if tareas && tareas.length > 0
              ul.task-list
                each t in tareas
                  li.task-item
                    .task-info
                      .task-main
                        strong.task-name= t.nombre
                        p.task-desc= t.descripcion || 'Sin descripci√≥n'
                      .task-meta
                        small.task-project üìÅ #{t.project ? t.project.nombre : 'N/A'}
                        if t.empleados && t.empleados.length > 0
                          small.task-assigned üë§ 
                            each emp, i in t.empleados
                              span= emp.nombre + ' ' + (emp.apellido || '')
                              if i < t.empleados.length - 1
                                span , 
                        else
                          small.task-assigned üë§ Sin asignar
                    .task-actions
                      if user && user.rol === 'administrador'
                        a.btn-edit(href="#", onclick="openEditTaskModal('" + t._id + "'); return false;") ‚úèÔ∏è
                        form(action="/tasks/" + t._id + "?_method=DELETE", method="POST", style="display:inline")
                          button.btn-delete(type="submit", onclick="return confirm('¬øEliminar tarea?')") üóëÔ∏è
                      else
                        form(action="/tasks/" + t._id + "/estado", method="POST")
                          select(name="estado", onchange="this.form.submit()")
                            option(value="pendiente", selected=t.estado==='pendiente') Pendiente
                            option(value="en proceso", selected=t.estado==='en proceso') En proceso
                            option(value="finalizada", selected=t.estado==='finalizada') Finalizada
            else
              p.text-muted No hay tareas disponibles.

      //- GESTI√ìN DE EMPLEADOS (solo admin)
      if user && user.rol === 'administrador'
        .dash-card.admin-section
          .dash-card-header
            h3 Gesti√≥n de Empleados
            a.btn-view-all(href="#", onclick="openEmployeeModal(); return false;") ‚ûï Nuevo Empleado
          .dash-card-body
            if empleados && empleados.length > 0
              ul.employee-list
                each e in empleados
                  li.employee-item
                    .employee-info
                      .employee-details
                        span.emp-name= e.nombre + ' ' + (e.apellido || '')
                        span.emp-email= e.email
                      span.emp-role(class=e.rol === 'administrador' ? 'role-admin' : 'role-employee')= e.rol
                    .emp-actions
                      a.btn-edit(href="#", onclick="openEditEmployeeModal('" + e._id + "', '" + e.nombre + "', '" + (e.apellido || '') + "', '" + e.email + "', '" + e.rol + "'); return false;") ‚úèÔ∏è
                      form(action="/employee/" + e._id + "?_method=DELETE", method="POST", style="display:inline")
                        button.btn-delete(type="submit", onclick="return confirm('¬øEliminar empleado?')") üóëÔ∏è
            else
              p.text-muted No hay empleados registrados.

      //- M√âTRICAS
      .dash-card.metrics-section
        .dash-card-header
          h3 üìä M√©tricas de Tareas
        .dash-card-body
          .metrics-grid
            .metric-card.metric-pendiente
              .metric-icon üìã
              .metric-content
                .metric-value= metricas.tareasPendientes
                .metric-label Pendientes
            .metric-card.metric-proceso
              .metric-icon ‚ö°
              .metric-content
                .metric-value= metricas.tareasEnProceso
                .metric-label En Proceso
            .metric-card.metric-finalizada
              .metric-icon ‚úÖ
              .metric-content
                .metric-value= metricas.tareasFinalizadas
                .metric-label Finalizadas
            .metric-card.metric-total
              .metric-icon üìà
              .metric-content
                .metric-value= metricas.totalTareas
                .metric-label Total

      //- CONSULTAS (solo admin)
      if user && user.rol === 'administrador'
        .dash-card.consultas-section
          .dash-card-header
            h3 üì© Consultas de Clientes
            if consultas && consultas.length > 0
              - const nuevas = consultas.filter(c => c.estado === 'nuevo').length
              if nuevas > 0
                span.consultas-badge= nuevas
          .dash-card-body
            if consultas && consultas.length > 0
              ul.consultas-list
                each c in consultas
                  li.consulta-item(class=c.estado)
                    .consulta-main
                      .consulta-header
                        strong.consulta-nombre= c.nombre + ' ' + c.apellido
                        span.consulta-badge(class='badge-' + c.estado)= c.estado
                      .consulta-details
                        small.consulta-email üìß #{c.email}
                        small.consulta-servicio üéØ #{c.servicio}
                        if c.consulta
                          p.consulta-mensaje= c.consulta
                    .consulta-actions
                      if c.estado === 'nuevo'
                        form(action="/clientes/" + c._id + "/estado", method="POST", style="display:inline")
                          input(type="hidden", name="estado", value="contactado")
                          button.btn-contactar(type="submit") ‚úì
                      if c.estado === 'contactado'
                        form(action="/clientes/" + c._id + "/estado", method="POST", style="display:inline")
                          input(type="hidden", name="estado", value="cerrado")
                          button.btn-cerrar(type="submit") ‚úÖ
                      form(action="/clientes/" + c._id + "?_method=DELETE", method="POST", style="display:inline")
                        button.btn-delete(type="submit", onclick="return confirm('¬øEliminar consulta?')") üóëÔ∏è
            else
              p.text-muted No hay consultas registradas.

    //- MODAL NUEVO PROYECTO
    #projectModalOverlay.modal-overlay
      .modal-container
        .modal-header
          h2 Nuevo Proyecto
          button.modal-close(onclick="closeProjectModal()") &times;
        form#projectForm(action="/project/save", method="POST")
          .modal-body
            .form-group
              label(for="projectName") Nombre del Proyecto *
              input(type="text", name="nombre", id="projectName", required, placeholder="Ej: Redise√±o Web Corporativo")
            .form-group
              label(for="projectClient") Cliente *
              select(name="clienteId", id="projectClient", required)
                option(value="", disabled, selected) Seleccionar cliente...
                if clientes && clientes.length > 0
                  each cliente in clientes
                    option(value=cliente._id)= cliente.nombre + ' ' + (cliente.apellido || '')
                else
                  option(value="", disabled) No hay clientes registrados
            .form-group
              label(for="projectDescription") Descripci√≥n
              textarea(name="descripcion", id="projectDescription", placeholder="Describe brevemente el proyecto...")
            .form-group
              label Servicios Asociados
              .servicios-container
                label.servicio-chip(data-horas="40")
                  input(type="checkbox", name="servicios[]", value="dise√±o_web")
                  span Dise√±o Web (40h)
                label.servicio-chip(data-horas="30")
                  input(type="checkbox", name="servicios[]", value="seo")
                  span SEO (30h)
                label.servicio-chip(data-horas="25")
                  input(type="checkbox", name="servicios[]", value="adwords")
                  span AdWords (25h)
                label.servicio-chip(data-horas="35")
                  input(type="checkbox", name="servicios[]", value="cm")
                  span Community Manager (35h)
                label.servicio-chip(data-horas="20")
                  input(type="checkbox", name="servicios[]", value="email_marketing")
                  span Email Marketing (20h)
                label.servicio-chip(data-horas="30")
                  input(type="checkbox", name="servicios[]", value="google_ads")
                  span Google Ads (30h)
                label.servicio-chip(data-horas="28")
                  input(type="checkbox", name="servicios[]", value="rrss_ads")
                  span Publicidad RRSS (28h)
            .form-group
              label(for="horasCotizadas") Horas Totales Cotizadas
              input(type="number", name="horasCotizadas", id="horasCotizadas", readonly, value="0")
            .form-group
              label(for="projectStatus") Estado Inicial
              select(name="estado", id="projectStatus")
                option(value="pendiente", selected) Pendiente
                option(value="en curso") En curso
                option(value="finalizado") Finalizado
          .modal-footer
            button.btn-modal.btn-cancel(type="button", onclick="closeProjectModal()") Cancelar
            button.btn-modal.btn-submit(type="submit") Crear Proyecto

    //- MODAL NUEVA/EDITAR TAREA
    #taskModalOverlay.modal-overlay
      .modal-container
        .modal-header
          h2#taskModalTitle Nueva Tarea
          button.modal-close(onclick="closeTaskModal()") &times;
        form#taskForm(action="/tasks/save", method="POST")
          input(type="hidden", name="taskId", id="taskId")
          .modal-body
            .form-group
              label(for="taskName") T√≠tulo de la Tarea *
              input(type="text", name="nombre", id="taskName", required, placeholder="Ej: Dise√±ar mockup homepage")
            .form-group
              label(for="taskDescription") Descripci√≥n de la Tarea
              textarea(name="descripcion", id="taskDescription", placeholder="Detalla qu√© debe hacerse...")
            .form-group
              label(for="taskProject") Proyecto Asociado *
              select(name="project", id="taskProject", required)
                option(value="", disabled, selected) Seleccionar proyecto...
                if proyectos && proyectos.length > 0
                  each proyecto in proyectos
                    option(value=proyecto._id)= proyecto.nombre
                else
                  option(value="", disabled) No hay proyectos disponibles
            .form-group
              label(for="taskEmployees") Asignar Empleados
              select(name="empleados", id="taskEmployees", multiple, size="4")
                if empleados && empleados.length > 0
                  each empleado in empleados
                    option(value=empleado._id)= empleado.nombre + ' ' + (empleado.apellido || '')
                else
                  option(value="", disabled) No hay empleados disponibles
              small.hint-text Mant√©n Ctrl para seleccionar m√∫ltiples
            .form-group
              label(for="taskStatus") Estado Inicial
              select(name="estado", id="taskStatus")
                option(value="pendiente", selected) Pendiente
                option(value="en proceso") En proceso
                option(value="finalizada") Finalizada
          .modal-footer
            button.btn-modal.btn-cancel(type="button", onclick="closeTaskModal()") Cancelar
            button.btn-modal.btn-submit(type="submit", id="taskSubmitBtn") Crear Tarea

    //- MODAL NUEVO/EDITAR EMPLEADO
    #employeeModalOverlay.modal-overlay
      .modal-container
        .modal-header
          h2#employeeModalTitle Nuevo Empleado
          button.modal-close(onclick="closeEmployeeModal()") &times;
        form#employeeForm(action="/employee/save", method="POST")
          input(type="hidden", name="employeeId", id="employeeId")
          .modal-body
            .form-group
              label(for="employeeName") Nombre *
              input(type="text", name="nombre", id="employeeName", required, placeholder="Ej: Juan")
            .form-group
              label(for="employeeLastName") Apellido *
              input(type="text", name="apellido", id="employeeLastName", required, placeholder="Ej: P√©rez")
            .form-group
              label(for="employeeEmail") Email *
              input(type="email", name="email", id="employeeEmail", required, placeholder="Ej: juan@clickwave.com")
            .form-group
              label(for="employeePassword") Contrase√±a *
              input(type="password", name="password", id="employeePassword", placeholder="M√≠nimo 6 caracteres")
              small.password-hint Se requiere solo al crear nuevo empleado
            .form-group
              label(for="employeeRole") Rol *
              select(name="rol", id="employeeRole", required)
                option(value="", disabled, selected) Seleccionar rol...
                option(value="empleado") Empleado
                option(value="administrador") Administrador
          .modal-footer
            button.btn-modal.btn-cancel(type="button", onclick="closeEmployeeModal()") Cancelar
            button.btn-modal.btn-submit(type="submit", id="employeeSubmitBtn") Crear Empleado

    //- SCRIPTS
    script.
      // Modal Proyecto
      function openProjectModal() {
        document.getElementById('projectModalOverlay').classList.add('show');
      }
      function closeProjectModal() {
        document.getElementById('projectModalOverlay').classList.remove('show');
        document.getElementById('projectForm').reset();
      }

      // Modal Tarea
      function openTaskModal() {
        document.getElementById('taskForm').reset();
        document.getElementById('taskId').value = '';
        document.getElementById('taskModalTitle').textContent = 'Nueva Tarea';
        document.getElementById('taskSubmitBtn').textContent = 'Crear Tarea';
        document.getElementById('taskForm').action = '/tasks/save';
        document.getElementById('taskModalOverlay').classList.add('show');
      }
      function openEditTaskModal(id) {
        fetch('/tasks/' + id)
          .then(function(res) { return res.json(); })
          .then(function(task) {
            document.getElementById('taskId').value = id;
            document.getElementById('taskName').value = task.nombre;
            document.getElementById('taskDescription').value = task.descripcion || '';
            document.getElementById('taskProject').value = task.project._id || task.project;
            document.getElementById('taskStatus').value = task.estado;
            var empSelect = document.getElementById('taskEmployees');
            for (var i = 0; i < empSelect.options.length; i++) {
              var opt = empSelect.options[i];
              opt.selected = task.empleados && task.empleados.some(function(emp) {
                return (emp._id || emp) === opt.value;
              });
            }
            document.getElementById('taskModalTitle').textContent = 'Editar Tarea';
            document.getElementById('taskSubmitBtn').textContent = 'Guardar Cambios';
            document.getElementById('taskForm').action = '/tasks/update/' + id;
            document.getElementById('taskModalOverlay').classList.add('show');
          })
          .catch(function(err) {
            console.error('Error:', err);
            alert('Error al cargar la tarea');
          });
      }
      function closeTaskModal() {
        document.getElementById('taskModalOverlay').classList.remove('show');
        document.getElementById('taskForm').reset();
      }

      // Modal Empleado
      function openEmployeeModal() {
        document.getElementById('employeeForm').reset();
        document.getElementById('employeeId').value = '';
        document.getElementById('employeeModalTitle').textContent = 'Nuevo Empleado';
        document.getElementById('employeeSubmitBtn').textContent = 'Crear Empleado';
        document.getElementById('employeeForm').action = '/employee/save';
        document.getElementById('employeePassword').required = true;
        document.querySelector('.password-hint').style.display = 'block';
        document.getElementById('employeeModalOverlay').classList.add('show');
      }
      function openEditEmployeeModal(id, nombre, apellido, email, rol) {
        document.getElementById('employeeId').value = id;
        document.getElementById('employeeName').value = nombre;
        document.getElementById('employeeLastName').value = apellido;
        document.getElementById('employeeEmail').value = email;
        document.getElementById('employeeRole').value = rol;
        document.getElementById('employeePassword').value = '';
        document.getElementById('employeePassword').required = false;
        document.querySelector('.password-hint').style.display = 'none';
        document.getElementById('employeeModalTitle').textContent = 'Editar Empleado';
        document.getElementById('employeeSubmitBtn').textContent = 'Guardar Cambios';
        document.getElementById('employeeForm').action = '/employee/update/' + id;
        document.getElementById('employeeModalOverlay').classList.add('show');
      }
      function closeEmployeeModal() {
        document.getElementById('employeeModalOverlay').classList.remove('show');
        document.getElementById('employeeForm').reset();
      }

      // Cerrar modales con ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeProjectModal();
          closeTaskModal();
          closeEmployeeModal();
        }
      });

      // Cerrar modales al hacer clic fuera
      document.getElementById('projectModalOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeProjectModal();
      });
      document.getElementById('taskModalOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeTaskModal();
      });
      document.getElementById('employeeModalOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeEmployeeModal();
      });

      // Calcular horas por servicios
      document.querySelectorAll('.servicio-chip').forEach(function(chip) {
        var checkbox = chip.querySelector('input[type="checkbox"]');
        chip.addEventListener('click', function(e) {
          if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
          chip.classList.toggle('selected', checkbox.checked);
          calcularHorasTotales();
        });
      });
      function calcularHorasTotales() {
        var total = 0;
        document.querySelectorAll('.servicio-chip input[type="checkbox"]:checked').forEach(function(cb) {
          var chip = cb.closest('.servicio-chip');
          total += parseInt(chip.getAttribute('data-horas')) || 0;
        });
        var input = document.getElementById('horasCotizadas');
        if (input) input.value = total;
      }