doctype html
html(lang="es")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Dashboard | Clickwave
    link(href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap", rel="stylesheet")
    link(rel="stylesheet", href="/css/dashboard.css")
    link(rel="stylesheet", href="/css/modals.css")
    script(src="/js/dashboard.js" defer)
  body.dashboard-layout
    // HEADER SUPERIOR
    header.header
      .header-left
        h1.logo Clickwave
      .header-center
        input#globalSearch(type="text", placeholder="Buscar proyectos, tareas o empleados...")
      .header-right
        span.user-name #{user ? user.nombre : 'Empleado'}
        a(href="/auth/logout").logout-btn Cerrar sesiÃ³n

    // CONTENIDO PRINCIPAL
    main.main-content
      h2 Mi Dashboard

      .dashboard-grid
        // ================== PROYECTOS (izquierda)
        .dash-card#projectsCard
          .dash-card-header
            h3 Proyectos
            if user && user.rol === 'administrador'
              a.btn-view-all(href="#" onclick="openProjectModal(); return false;") âž• Nuevo
          .dash-card-body
            ul.project-list#projectList
              if proyectos && proyectos.length > 0
                each proyecto in proyectos
                  li.project-item
                    .left
                      strong.project-name= proyecto.nombre
                      if proyecto.horasCotizadas
                        small.project-hours ðŸ’¼ #{proyecto.horasCotizadas} horas cotizadas
                    .right
                      if user && user.rol === 'administrador'
                        form(action=`/project/${proyecto._id}?_method=PUT`, method="POST", class="inline-form")
                          select(name="estado", onchange="this.form.submit()")
                            option(value="pendiente", selected=proyecto.estado==='pendiente') Pendiente
                            option(value="en curso", selected=proyecto.estado==='en curso') En curso
                            option(value="finalizado", selected=proyecto.estado==='finalizado') Finalizado
                        a.btn-edit(href=`/project/${proyecto._id}/edit`) âœï¸
                        button.btn-delete(type="button", onclick=`deleteProject('${proyecto._id}')`) ðŸ—‘ï¸
                      else
                        span.badge(class=`item-status ${proyecto.estado}`)= proyecto.estado
              else
                li No hay proyectos asignados.

        // ================== TAREAS (derecha)
        .dash-card#tasksCard
          .dash-card-header
            h3 Tareas del Proyecto
            if user && user.rol === 'administrador'
              a.btn-view-all(href="#" onclick="openTaskModal(); return false;") âž• Nueva
          .dash-card-body
            if tareas && tareas.length > 0
              ul.task-list#taskList
                each t in tareas
                  li.task-item
                    .task-info
                      .task-main
                        strong.task-name= t.nombre
                        p.task-desc= t.descripcion || 'Sin descripciÃ³n'
                      .task-meta
                        small.task-project ðŸ“ Proyecto: #{t.project ? t.project.nombre : 'N/A'}
                        if t.empleados && t.empleados.length > 0
                          small.task-assigned ðŸ‘¤ Asignado a: 
                            each emp, index in t.empleados
                              span= emp.nombre + ' ' + (emp.apellido || '')
                              if index < t.empleados.length - 1
                                span , 
                        else
                          small.task-assigned ðŸ‘¤ Sin asignar
                    .task-actions
                      if user && user.rol === 'administrador'
                        a.btn-edit(href="#" onclick=`openEditTaskModal('${t._id}'); return false;`) âœï¸
                        button.btn-delete(type="button", onclick=`deleteTask('${t._id}')`) ðŸ—‘ï¸
                      else
                        form(action=`/tasks/${t._id}?_method=PUT`, method="POST")
                          select(name="estado", onchange="this.form.submit()")
                            option(value="pendiente", selected=t.estado==='pendiente') Pendiente
                            option(value="en proceso", selected=t.estado==='en proceso') En proceso
                            option(value="finalizada", selected=t.estado==='finalizada') Finalizada
            else
              p.text-muted No hay tareas disponibles.

      // ================== ADMINISTRACIÃ“N Y EMPLEADOS
      if user && user.rol === 'administrador'
        .dash-card.admin-section
          .dash-card-header
            h3 GestiÃ³n de Empleados
            a.btn-view-all(href="#" onclick="openEmployeeModal(); return false;") âž• Nuevo Empleado
          .dash-card-body
            if empleados && empleados.length > 0
              ul.employee-list#employeeList
                each e in empleados
                  li.employee-item
                    .employee-info
                      .employee-details
                        span.emp-name= `${e.nombre} ${e.apellido || ''}`
                        span.emp-email= e.email
                      span.emp-role(class=e.rol === 'administrador' ? 'role-admin' : 'role-employee')= e.rol
                    .emp-actions
                      a.btn-edit(href="#" onclick=`openEditEmployeeModal('${e._id}', '${e.nombre}', '${e.apellido || ''}', '${e.email}', '${e.rol}'); return false;` title="Editar empleado") âœï¸
                      button.btn-delete(type="button" onclick=`deleteEmployee('${e._id}')` title="Eliminar empleado") ðŸ—‘ï¸
            else
              p.text-muted No hay empleados registrados.

      // ================== MÃ‰TRICAS DE TAREAS
      .dash-card.metrics-section
        .dash-card-header
          h3 ðŸ“Š MÃ©tricas de Tareas
        .dash-card-body
          .metrics-grid
            .metric-card.metric-pendiente
              .metric-icon ðŸ“‹
              .metric-content
                .metric-value= metricas.tareasPendientes
                .metric-label Pendientes
            
            .metric-card.metric-proceso
              .metric-icon âš¡
              .metric-content
                .metric-value= metricas.tareasEnProceso
                .metric-label En Proceso
            
            .metric-card.metric-finalizada
              .metric-icon âœ…
              .metric-content
                .metric-value= metricas.tareasFinalizadas
                .metric-label Finalizadas
            
            .metric-card.metric-total
              .metric-icon ðŸ“ˆ
              .metric-content
                .metric-value= metricas.totalTareas
                .metric-label Total

      // ================== CONSULTAS DE CLIENTES
      if user && user.rol === 'administrador'
        .dash-card.consultas-section
          .dash-card-header
            h3 ðŸ“© Consultas de Clientes
            if consultas && consultas.length > 0
              span.consultas-badge= consultas.filter(c => c.estado === 'nuevo').length
          .dash-card-body
            if consultas && consultas.length > 0
              ul.consultas-list
                each c in consultas
                  li.consulta-item(class=`estado-${c.estado}`)
                    .consulta-main
                      .consulta-header
                        strong.consulta-nombre= `${c.nombre} ${c.apellido}`
                        span.consulta-badge(class=`badge-${c.estado}`)= c.estado
                      .consulta-details
                        small.consulta-email ðŸ“§ #{c.email}
                        small.consulta-servicio ðŸŽ¯ #{c.servicio.replace(/_/g, ' ')}
                        if c.consulta
                          p.consulta-mensaje= c.consulta
                        small.consulta-fecha ðŸ“… #{new Date(c.createdAt).toLocaleDateString('es-AR', { year: 'numeric', month: 'long', day: 'numeric' })}
                    .consulta-actions
                      if c.estado === 'nuevo'
                        form(action=`/clientes/${c._id}/estado`, method="POST", style="display: inline;")
                          input(type="hidden", name="estado", value="contactado")
                          button.btn-contactar(type="submit", title="Marcar como contactado") âœ“
                      if c.estado === 'contactado'
                        form(action=`/clientes/${c._id}/estado`, method="POST", style="display: inline;")
                          input(type="hidden", name="estado", value="cerrado")
                          button.btn-cerrar(type="submit", title="Marcar como cerrado") âœ…
                      button.btn-delete(type="button", onclick=`deleteConsulta('${c._id}')`, title="Eliminar") ðŸ—‘ï¸
            else
              p.text-muted No hay consultas registradas.

    // ================== MODALES (Proyectos, Tareas, Empleados)
    #projectModalOverlay.modal-overlay
      .modal-container
        .modal-header
          h2 Nuevo Proyecto
          button.modal-close(onclick="closeProjectModal()") &times;
        form#projectForm(action="/project/save", method="POST")
          .modal-body
            .form-group
              label(for="projectName") Nombre del Proyecto *
              input(type="text", name="nombre", id="projectName", required, placeholder="Ej: RediseÃ±o Web Corporativo")
            .form-group
              label(for="projectClient") Cliente *
              select(name="clienteId", id="projectClient", required)
                option(value="", disabled, selected) Seleccionar cliente...
                if clientes && clientes.length > 0
                  each cliente in clientes
                    option(value=cliente._id)= `${cliente.nombre} ${cliente.apellido || ''}`
                else
                  option(value="", disabled) No hay clientes registrados
            .form-group
              label(for="projectDescription") DescripciÃ³n
              textarea(name="descripcion", id="projectDescription", placeholder="Describe brevemente el proyecto...")
            .form-group
              label Servicios Asociados (las horas se calculan automÃ¡ticamente)
              .servicios-container
                label.servicio-chip(data-horas="40")
                  input(type="checkbox", name="servicios[]", value="diseÃ±o_web")
                  span DiseÃ±o Web (40h)
                label.servicio-chip(data-horas="30")
                  input(type="checkbox", name="servicios[]", value="seo")
                  span SEO (30h)
                label.servicio-chip(data-horas="25")
                  input(type="checkbox", name="servicios[]", value="adwords")
                  span AdWords (25h)
                label.servicio-chip(data-horas="35")
                  input(type="checkbox", name="servicios[]", value="cm")
                  span Community Manager (35h)
                label.servicio-chip(data-horas="20")
                  input(type="checkbox", name="servicios[]", value="email_marketing")
                  span Email Marketing (20h)
                label.servicio-chip(data-horas="30")
                  input(type="checkbox", name="servicios[]", value="google_ads")
                  span Google Ads (30h)
                label.servicio-chip(data-horas="28")
                  input(type="checkbox", name="servicios[]", value="rrss_ads")
                  span Publicidad RRSS (28h)
            .form-group
              label(for="horasCotizadas") Horas Totales Cotizadas
              input(type="number", name="horasCotizadas", id="horasCotizadas", readonly, value="0", style="background: #f3f4f6; cursor: not-allowed;")
            .form-group
              label(for="projectStatus") Estado Inicial
              select(name="estado", id="projectStatus")
                option(value="pendiente", selected) Pendiente
                option(value="en curso") En curso
                option(value="finalizado") Finalizado
          .modal-footer
            button.btn-modal.btn-cancel(type="button", onclick="closeProjectModal()") Cancelar
            button.btn-modal.btn-submit(type="submit") Crear Proyecto

    #taskModalOverlay.modal-overlay
      .modal-container
        .modal-header
          h2#taskModalTitle Nueva Tarea
          button.modal-close(onclick="closeTaskModal()") &times;
        form#taskForm(action="/tasks/save", method="POST")
          input(type="hidden", name="taskId", id="taskId")
          .modal-body
            .form-group
              label(for="taskName") TÃ­tulo de la Tarea *
              input(type="text", name="nombre", id="taskName", required, placeholder="Ej: DiseÃ±ar mockup homepage")
            .form-group
              label(for="taskDescription") DescripciÃ³n de la Tarea
              textarea(name="descripcion", id="taskDescription", placeholder="Detalla quÃ© debe hacerse en esta tarea...")
            .form-group
              label(for="taskProject") Proyecto Asociado *
              select(name="project", id="taskProject", required)
                option(value="", disabled, selected) Seleccionar proyecto...
                if proyectos && proyectos.length > 0
                  each proyecto in proyectos
                    option(value=proyecto._id)= proyecto.nombre
                else
                  option(value="", disabled) No hay proyectos disponibles
            .form-group
              label(for="taskEmployees") Asignar Empleados
              select(name="empleados", id="taskEmployees", multiple, size="4")
                if empleados && empleados.length > 0
                  each empleado in empleados
                    option(value=empleado._id)= `${empleado.nombre} ${empleado.apellido || ''}`
                else
                  option(value="", disabled) No hay empleados disponibles
              small.hint-text MantÃ©n Ctrl (Cmd en Mac) para seleccionar mÃºltiples empleados
            .form-group
              label(for="taskStatus") Estado Inicial
              select(name="estado", id="taskStatus")
                option(value="pendiente", selected) Pendiente
                option(value="en proceso") En proceso
                option(value="finalizada") Finalizada
          .modal-footer
            button.btn-modal.btn-cancel(type="button", onclick="closeTaskModal()") Cancelar
            button.btn-modal.btn-submit(type="submit" id="taskSubmitBtn") Crear Tarea

    #employeeModalOverlay.modal-overlay
      .modal-container
        .modal-header
          h2#employeeModalTitle Nuevo Empleado
          button.modal-close(onclick="closeEmployeeModal()") &times;
        form#employeeForm(action="/employee/save", method="POST")
          input(type="hidden", name="employeeId", id="employeeId")
          .modal-body
            .form-group
              label(for="employeeName") Nombre *
              input(type="text", name="nombre", id="employeeName", required, placeholder="Ej: Juan")
            .form-group
              label(for="employeeLastName") Apellido *
              input(type="text", name="apellido", id="employeeLastName", required, placeholder="Ej: PÃ©rez")
            .form-group
              label(for="employeeEmail") Email *
              input(type="email", name="email", id="employeeEmail", required, placeholder="Ej: juan.perez@clickwave.com")
            .form-group
              label(for="employeePassword") ContraseÃ±a *
              input(type="password", name="password", id="employeePassword", placeholder="MÃ­nimo 6 caracteres")
              small.password-hint Se requiere solo al crear un nuevo empleado
            .form-group
              label(for="employeeRole") Rol *
              select(name="rol", id="employeeRole", required)
                option(value="", disabled, selected) Seleccionar rol...
                option(value="empleado") Empleado
                option(value="administrador") Administrador
          .modal-footer
            button.btn-modal.btn-cancel(type="button", onclick="closeEmployeeModal()") Cancelar
            button.btn-modal.btn-submit(type="submit" id="employeeSubmitBtn") Crear Empleado

    script.
      async function deleteProject(id) {
        if (!confirm('Â¿Eliminar proyecto y sus tareas asociadas?')) return;
        await fetch(`/project/${id}`, { method: 'DELETE' });
        location.reload();
      }
      async function deleteTask(id) {
        if (!confirm('Â¿Eliminar esta tarea?')) return;
        try {
          const response = await fetch(`/tasks/${id}`, { method: 'DELETE' });
          if (response.ok) location.reload();
          else alert('Error al eliminar la tarea');
        } catch (error) {
          console.error('Error:', error);
          alert('Error al eliminar la tarea');
        }
      }
      async function deleteEmployee(id) {
        if (!confirm('Â¿EstÃ¡s seguro de eliminar este empleado?')) return;
        try {
          const response = await fetch(`/employee/${id}`, { method: 'DELETE' });
          if (response.ok) location.reload();
          else alert('Error al eliminar el empleado');
        } catch (error) {
          console.error('Error:', error);
          alert('Error al eliminar el empleado');
        }
      }
      async function deleteConsulta(id) {
        if (!confirm('Â¿Eliminar esta consulta?')) return;
        try {
          const response = await fetch(`/clientes/${id}`, { method: 'DELETE' });
          if (response.ok) location.reload();
          else alert('Error al eliminar la consulta');
        } catch (error) {
          console.error('Error:', error);
          alert('Error al eliminar la consulta');
        }
      }
      function openProjectModal() { document.getElementById('projectModalOverlay').classList.add('show'); }
      function closeProjectModal() { document.getElementById('projectModalOverlay').classList.remove('show'); document.getElementById('projectForm').reset(); }
      function openTaskModal() {
        document.getElementById('taskForm').reset();
        document.getElementById('taskId').value = '';
        document.getElementById('taskModalTitle').textContent = 'Nueva Tarea';
        document.getElementById('taskSubmitBtn').textContent = 'Crear Tarea';
        document.getElementById('taskForm').action = '/tasks/save';
        document.getElementById('taskModalOverlay').classList.add('show');
      }
      async function openEditTaskModal(id) {
        try {
          const response = await fetch(`/tasks/${id}`);
          const task = await response.json();
          document.getElementById('taskId').value = id;
          document.getElementById('taskName').value = task.nombre;
          document.getElementById('taskDescription').value = task.descripcion || '';
          document.getElementById('taskProject').value = task.project._id || task.project;
          document.getElementById('taskStatus').value = task.estado;
          const employeeSelect = document.getElementById('taskEmployees');
          Array.from(employeeSelect.options).forEach(option => {
            option.selected = task.empleados && task.empleados.some(emp => (emp._id || emp) === option.value);
          });
          document.getElementById('taskModalTitle').textContent = 'Editar Tarea';
          document.getElementById('taskSubmitBtn').textContent = 'Guardar Cambios';
          document.getElementById('taskForm').action = `/tasks/update/${id}`;
          document.getElementById('taskModalOverlay').classList.add('show');
        } catch (error) {
          console.error('Error al cargar tarea:', error);
          alert('Error al cargar los datos de la tarea');
        }
      }
      function closeTaskModal() { document.getElementById('taskModalOverlay').classList.remove('show'); document.getElementById('taskForm').reset(); }
      function openEmployeeModal() {
        document.getElementById('employeeForm').reset();
        document.getElementById('employeeId').value = '';
        document.getElementById('employeeModalTitle').textContent = 'Nuevo Empleado';
        document.getElementById('employeeSubmitBtn').textContent = 'Crear Empleado';
        document.getElementById('employeeForm').action = '/employee/save';
        document.getElementById('employeePassword').required = true;
        document.querySelector('.password-hint').style.display = 'block';
        document.getElementById('employeeModalOverlay').classList.add('show');
      }
      function openEditEmployeeModal(id, nombre, apellido, email, rol) {
        document.getElementById('employeeId').value = id;
        document.getElementById('employeeName').value = nombre;
        document.getElementById('employeeLastName').value = apellido;
        document.getElementById('employeeEmail').value = email;
        document.getElementById('employeeRole').value = rol;
        document.getElementById('employeePassword').value = '';
        document.getElementById('employeePassword').required = false;
        document.querySelector('.password-hint').style.display = 'none';
        document.getElementById('employeeModalTitle').textContent = 'Editar Empleado';
        document.getElementById('employeeSubmitBtn').textContent = 'Guardar Cambios';
        document.getElementById('employeeForm').action = `/employee/update/${id}`;
        document.getElementById('employeeModalOverlay').classList.add('show');
      }
      function closeEmployeeModal() { document.getElementById('employeeModalOverlay').classList.remove('show'); document.getElementById('employeeForm').reset(); }
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') { closeProjectModal(); closeTaskModal(); closeEmployeeModal(); }
      });
      document.getElementById('projectModalOverlay').addEventListener('click', function(e) { if (e.target === this) closeProjectModal(); });
      document.getElementById('taskModalOverlay').addEventListener('click', function(e) { if (e.target === this) closeTaskModal(); });
      document.getElementById('employeeModalOverlay').addEventListener('click', function(e) { if (e.target === this) closeEmployeeModal(); });
      document.querySelectorAll('.servicio-chip').forEach(chip => {
        const checkbox = chip.querySelector('input[type="checkbox"]');
        chip.addEventListener('click', function(e) {
          if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
          this.classList.toggle('selected', checkbox.checked);
          calcularHorasTotales();
        });
      });
      function calcularHorasTotales() {
        let totalHoras = 0;
        document.querySelectorAll('.servicio-chip input[type="checkbox"]:checked').forEach(checkbox => {
          const chip = checkbox.closest('.servicio-chip');
          totalHoras += parseInt(chip.getAttribute('data-horas')) || 0;
        });
        const horasInput = document.getElementById('horasCotizadas');
        if (horasInput) horasInput.value = totalHoras;
      }